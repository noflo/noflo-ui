<link rel="import" href="../node_modules/the-graph/the-graph-thumb/the-graph-thumb.html">
<link rel="import" href="noflo-anonymous.html">
<link rel="import" href="noflo-account.html">
<link rel="import" href="noflo-new-project.html">
<link rel="import" href="noflo-new-repository.html">
<link rel="import" href="noflo-new-runtime.html">
<polymer-element name="noflo-main" attributes="project projects graphs components runtimes currentRuntimes">
  <template>
    <style>
      :host {
        background-color: hsl(190, 90%, 45%);
        display: block;
        z-index: 4;
        position: fixed;
        top: 0px;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        overflow-y: auto;
        height: 100%;
        width: 100%;
        transition: height 1s ease-in-out;
      }
      section {
        /*
        background-image: radial-gradient(1px at 0px 0px, hsl(210, 78%, 10%) 0.5px, hsla(0, 0%, 0%, 0) 1px);
        background-position: 50% 0px;
        background-size: 36px 36px;
        */
        display: block;
        position: relative;
        padding-left: 72px;
        padding-right: 72px;
      }
      section > h2 {
        font-size: 17px;
        line-height: 36px;
        margin-top: 36px;
        height: 36px;
        color: white;
        text-shadow: 0 1px 0 hsl(190, 100%, 40%);
        text-transform: none;
      }
      section > h2 small {
        font-size: 10px;
        text-transform: uppercase;
        color: hsl(189, 50%, 25%);
      }
      ul.tabs {
        position: absolute;
        display: inline-block;
        top: 0px;
        left: calc(50% - 133px);
        margin: 0px;
        padding: 0px;
        list-style: none;
        padding: 1px;
      }
      ul.tabs li {
        display: inline;
        line-height: 36px;
        font-size: 13px;
        color: hsl(189, 50%, 25%);
        text-decoration: none;
        padding-left: 36px;
        padding-right: 36px;
        cursor: pointer;
      }
      ul.tabs li.selected {
        border: none;
        border-radius: 3px;
        background-color: rgba(0, 42, 51, 0.498039);
        color: white;
        border-radius: 3px;
        padding-top: 8px;
        padding-bottom: 9px;
        cursor: default;
      }
      ul.projects {
        padding: 0px;
        margin-top: 36px;
        margin-bottom: 36px;
        margin-left: -18px;
        margin-right: -18px;
        list-style: none;
      }
      ul.projects li {
        width: 216px;
        height: 105px;
        overflow: hidden;
        display: inline-block;
        text-align: center;
        background-color: hsla(0, 0%, 0%, .98);
        border-radius: 3px;
        margin-right: 18px;
        margin-left: 18px;
        margin-bottom: 36px;
        position: relative;
        cursor: pointer;
      }
      ul.projects li.add,
      ul.projects li.plan {
        background-color: hsl(192, 25%, 92%);
        color: black;
        cursor: default;
      }
      ul.projects li.remote {
        cursor: default;
      }
      ul.projects li the-graph-thumb {
        display: block;
        position: absolute;
        left: 100px;
        top: -20px;
      }
      section button,
      section #cta {
        background-color: transparent;
        color: hsl(189, 50%, 25%);
        font-size: 13px;
        border-radius: 3px;
        font-family: "SourceCodePro",Helvetica,Arial,sans-serif;
        height: 36px;
        border: none;
        padding-left: 13px;
        padding-right: 13px;
        cursor: pointer;
      }
      ul.projects li button,
      ul.projects li #cta {
        display: block;
        border: 1px solid hsl(189, 50%, 25%);
        position: absolute;
        right: 18px;
        top: 36px;
      }
      ul.projects li h2 {
        position: absolute;
        top: 36px;
        line-height: 36px;
        width: 150px;
        text-transform: none;
        font-size: 12px;
        text-align: left;
        white-space: nowrap;
        left: 18px;
        padding: 0px;
        margin: 0px;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      ul.projects li p {
        position: absolute;
        top: 53px;
        left: 18px;
        width: 150px;
        text-transform: uppercase;
        font-size: 10px;
        text-align: left;
        max-height: 36px;
        overflow: hidden;
        color: hsl(189, 11%, 50%);
      }
      ul.projects li.plan p {
        width: 100px;
        font-size: 9px;
      }
      ul.projects li a {
        color: black;
        text-decoration: none;
      }
    </style>
    <noflo-account id="mainaccount" user="{{ user }}" avatar="{{ avatar }}" plan="{{ plan }}"></noflo-account>  
    <div id="loginrequired"></div>
      <section id="projects">
        <h2>Projects
            <template if="{{ projectList === 'local' }}">
            <small>{{ projects.length }}</small>
            </template>
            <template if="{{ projectList === 'github' }}">
            <small>{{ remoteProjects.length }}</small>
            </template>
            <template if="{{ projectList === 'github' }}">
            <button on-click="{{ fetchGithub }}"><i id="fetchgithub" class="fa fa-refresh"></i></button>
            </template>
        </h2>
        <ul class="tabs">
          <template if="{{ projectList === 'local' }}">
            <li class="selected">On device</li>
            <template if="{{ githubToken }}">
            <li on-click="{{ openGithub }}">GitHub</li>
            </template>
          </template>
          <template if="{{ projectList === 'github' }}">
            <li on-click="{{ openLocal }}">On device</li>
            <li class="selected">GitHub</li>
          </template>
        </ul>
        <ul class="projects">
          <template if="{{ projectList === 'local' }}">
          <li class="add">
            <h2>New project</h2>
            <button id="newproject" on-click="{{ newProject }}">Create</button>
          </li>
          <template repeat="{{ project in projects }}">
            <li on-click="{{ openProject }}" data-id="{{ project.id }}">
              <the-graph-thumb graph="{{ project.mainGraph }}" width="200" height="120"></the-graph-thumb>
              <h2>{{ project.name }}</h2>
              <template if="{{ project.graphs.length || project.components.length }}">
              <p>{{ project.graphs.length }}&nbsp;graphs, {{ project.components.length }}&nbsp;components</p>
              </template>
              <template if="{{ !project.graphs.length && !project.components.length }}">
              <button on-click="{{ deleteProject }}" data-id="{{ project.id }}"><i class="fa fa-trash-o"></i></button>
              </template>
            </li>
          </template>
          </template>
          <template if="{{ projectList === 'github' }}">
          <li class="add">
            <h2>Add a repository</h2>
            <button id="newrepository" on-click="{{ newRepository }}">Add</button>
          </li>
          <template if="{{ plan === 'free' }}">
          <li class="plan {{ plan }}">
            <h2>Flowhub free</h2>
            <p>Access only to public GitHub repositories.</p>
            <form method="post" action="https://plans.flowhub.io/auth/flowhub">
              <input type="hidden" name="username" value="{{ user.github.username }}">
              <input type="hidden" name="password" value="{{ gridToken }}">
              <input type="submit" id="cta" value="Upgrade">
            </form>
          </li>
          </template>
          <template repeat="{{ project in remoteProjects }}">
            <li class="remote">
              <h2>{{ project.repo }}</h2>
              <template if="{{ project.private }}">
              <p>Private repository</p>
                <template if="{{ plan !== 'free' }}">
                <button on-click="{{ downloadProject }}" data-repo="{{ project.repo }}"><i class="fa fa-cloud-download"></i></button>
                </template>
              </template>
              <template if="{{ !project.private }}">
              <p>Public repository</p>
              <button on-click="{{ downloadProject }}" data-repo="{{ project.repo }}"><i class="fa fa-cloud-download"></i></button>
              </template>
            </li>
          </template>
          </template>
        </ul>
      </section>
    <section id="runtimes">
      <h2>
        Runtimes <small>{{ currentRuntimes.length }} / {{ runtimes.length }}</small>
        <button on-click="{{ fetchRuntimes }}"><i id="fetchruntimes" class="fa fa-refresh"></i></button>
      </h2>
      <ul class="projects">
        <template if="{{ user && $NOFLO_USER_LOGIN_ENABLED }}">
          <li class="add">
            <h2>New runtime</h2>
            <button on-click="{{ newRuntime }}">Register</button>
          </li>
        </template>
        <template if="{{ !$NOFLO_USER_LOGIN_ENABLED }}">
          <li class="add">
            <h2>Runtime</h2>
            <button on-click="{{ addRuntime }}">Add new</button>
          </li>
        </template>  

        <template repeat="{{ currentRuntimes }}">
          <li on-click="{{ openRuntime }}" data-id="{{ id }}" data-protocol="{{ protocol }}" class="runtime {{ type }}">
            <h2>{{ label }}</h2>
            <p>{{ address }}. Seen {{ seenHoursAgo }}h ago</p>
          </li>
        </template>
      </ul>
    </section>
    <div id="loginrequiredChrome">
      <section id="examples">
        <h2>
          Examples <small>{{ examples.length }}</small>
        </h2>
        <ul class="projects">
          <template repeat="{{ examples }}">
          <li on-click="{{ openExample }}" data-id="{{ id }}" class="example">
            <h2>{{ label }}</h2>
            <p>{{ address }}</p>
          </li>
          </template>
        </ul>
      </section>
    </div>
  </template>
  <script>
    Polymer('noflo-main', {
      project: null,
      projects: [],
      remoteProjects: [],
      runtimes: [],
      currentRuntimes: [],
      examples: [],
      githubToken: '',
      gridToken: '',
      user: null,
      avatar: '',
      plan: '',
      projectList: 'local',
      languages: [
        'HTML',
        'JavaScript',
        'CoffeeScript',
        'C++'
      ],
      help: null,
      attached: function () {
        this.projectChanged();
        this.$.mainaccount.addEventListener('login', function (event) {
          this.fetchRuntimes();
        }.bind(this));
        this.$.mainaccount.addEventListener('relogin', function (event) {
          event.stopPropagation();
          this.fire('relogin', event.detail);
        }.bind(this));
        this.$.mainaccount.addEventListener('theme', function (event) {
          window.setTimeout(function () {
            this.fire('theme', event.detail);
          }.bind(this), 1000);
        }.bind(this));
        this.help = document.querySelector('noflo-help');

        // Hide projects if not logged in
        this.gridTokenChanged();
      },
      projectChanged: function () {
        if (!this.project) {
          // Make main visible
          this.style.height = '100%';
          return;
        }
        this.style.height = '0px';
      },
      openLocal: function (event) {
        if (event) {
          event.preventDefault();
        }
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        this.projectList = 'local';
      },
      openGithub: function (event) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        if (!this.gridToken) {
          return;
        }
        event.preventDefault();
        this.projectList = 'github';
        if (this.remoteProjects.length === 0) {
          setTimeout(function () {
            this.fetchGithub();
          }.bind(this), 1);
        }
      },
      deleteProject: function (event, details, sender) {
        event.preventDefault();
        event.stopPropagation();
        if (typeof ga === 'function') {
          ga('send', 'event', 'button', 'click', 'deleteProject');
        }
        var id = sender.getAttribute('data-id');
        var matches = this.projects.filter(function (proj) {
          if (proj.id === id) {
            return true;
          }
          return false;
        });
        if (!matches.length) {
          return;
        }
        this.fire('deleteProject', matches[0]);
      },
      downloadProject: function (event, details, sender) {
        event.preventDefault();
        event.stopPropagation();
        var slug = sender.getAttribute('data-repo').split('/');
        var branch = 'master';
        this.fire('hash', [
          'github',
          slug[0],
          slug[1],
          'tree',
          branch
        ]);
      },
      fetchGithub: function (event) {
        if (event) {
          event.preventDefault();
        }
        if (!this.githubToken || !this.gridToken) {
          return;
        }
        this.fire('fetchRemote', this.gridToken);
      },
      fetchRuntimes: function (event) {
        this.fire('fetchRuntimes', true);
      },
      gridTokenChanged: function () {
        // Hide projects if not logged in
        // Done like this instead of template if so this.$.fetchruntimes etc work
        if (this.gridToken) {
          this.$.loginrequired.style.display = 'block';
          if (typeof chrome !== 'undefined' && chrome.storage) {
            this.$.loginrequiredChrome.style.display = 'block';
          }
        } else {
          this.$.loginrequired.style.display = 'none';
          if (typeof chrome !== 'undefined' && chrome.storage) {
            this.$.loginrequiredChrome.style.display = 'none';
          }
        }
        this.$.mainaccount.gridToken = this.gridToken;
        setTimeout(this.fetchRuntimes.bind(this), 100);
      },
      openProject: function (event, details, sender) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        var project = null;
        this.projects.forEach(function (p) {
          if (p.id === sender.getAttribute('data-id')) {
            project = p;
          }
        });
        if (!project) {
          return;
        }
        if (project.graphs.length && !project.main) {
          project.main = project.graphs[0].id;
        }
        if (!project.main) {
          if (!project.components.length) {
            return;
          }
          this.fire('hash', [
            'project',
            project.id,
            'component',
            project.components[0].name
          ]);
          return;
        }
        this.fire('hash', [
          'project',
          project.id,
          project.main
        ]);
      },
      openRuntime: function (event, details, sender) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        if (sender.getAttribute('data-protocol') === 'iframe') {
          return;
        }
        this.fire('hash', [
          'runtime',
          sender.getAttribute('data-id')
        ]);
      },
      openExample: function (event, details, sender) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        this.fire('hash', [
          'gist',
          sender.getAttribute('data-id')
        ]);
      },
      newProject: function (event) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        var dialog = document.createElement('noflo-new-project');
        dialog.projects = this.projects;
        dialog.runtimes = this.runtimes;
        document.body.appendChild(dialog);
        dialog.addEventListener('new', function (event) {
          var noflo = require('noflo');
          var graph = new noflo.Graph('main');
          var graphId = event.detail.id + '/main';
          graph.setProperties({
            id: graphId,
            project: event.detail.id,
            environment: {
              type: event.detail.type
            }
          });
          event.detail.main = graphId;
          this.fire('newgraph', graph);
          this.fire('newproject', event.detail);
          event.detail.graphs.push(graph);
        }.bind(this));
      },
      newRepository: function (event) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        var dialog = document.createElement('noflo-new-repository');
        dialog.token = this.gridToken;
        dialog.addEventListener('new', function (event) {
          this.fire('hash', [
            'github',
            event.detail.repo,
            'tree',
            event.detail.branch
          ]);
        }.bind(this));
        document.body.appendChild(dialog);
      },
      newRuntime: function (event) {
        event.preventDefault();
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        var dialog = document.createElement('noflo-new-runtime');
        dialog.addEventListener('addRuntime', function(event) {
          var runtime = event.detail;
          this.fire('newruntime', event.detail);
        }.bind(this));
        dialog.user = this.user;
        document.body.appendChild(dialog);
      },
      addRuntime: function (event) {
        event.preventDefault(); 
        if (document.querySelectorAll('.modal-content:not(polymer-element)').length) {
          return;
        }
        this.runtimeAdd = document.createElement('noflo-add-runtime');
        document.body.appendChild(this.runtimeAdd);
        this.runtimeAdd.addEventListener('new', function(event) {
          var runtime = event.detail;
          this.runtimes.push(runtime);
        }.bind(this));
      }
    });
  </script>
</polymer-element>
