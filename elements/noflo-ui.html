<link rel="import" href="noflo-main.html">
<link rel="import" href="../node_modules/the-graph/the-graph-editor/the-graph-editor.html">
<link rel="import" href="noflo-library.html">
<link rel="import" href="noflo-context.html">
<link rel="import" href="noflo-runtime.html">
<link rel="import" href="noflo-journal.html">
<link rel="import" href="noflo-component-editor.html">
<link rel="import" href="noflo-search.html">
<link rel="import" href="noflo-project.html">
<link rel="import" href="noflo-packets.html">
<link rel="import" href="noflo-alert.html">
<polymer-element name="noflo-ui" attributes="width height">
  <template>
    <style>
      #grapheditor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
      #componenteditor {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 36px;
        right: 0;
        z-index: 0;
      }
      #alert {
        box-sizing: border-box;
        position: fixed;
        top: -144px;
        left: 0;
        right: 0;
        z-index: 10;
        max-height: 144px;
        overflow: hidden;
        transition: top 0.3s ease-in-out;
      }
      #alert.show {
        top: 0;
      }
    </style>
    <noflo-main id="main"></noflo-main>
    <the-graph-editor id="grapheditor" width="{{ width }}" height="{{ height }}"></the-graph-editor>
    <noflo-library id="library"></noflo-library>
    <noflo-context id="context"></noflo-context>
    <noflo-runtime id="runtime"></noflo-runtime>
    <noflo-journal id="journal"></noflo-journal>
    <noflo-component-editor id="componenteditor" width="{{ width }}" height="{{ height }}"></noflo-component-editor>
    <noflo-search id="search"></noflo-search>
    <noflo-project id="project"></noflo-project>
    <noflo-packets id="packets"></noflo-packets>
    <noflo-alert id="alert" on-click="{{ hideAlert }}"></noflo-alert>
  </template>
  <script>
    Polymer('noflo-ui', {
      width: window.innerWidth,
      height: window.innerHeight,
      ctx: {},
      dontAutoHideAlert: false,
      emitEvent: function (event, payload) {
        this.fire(event, payload);
      },
      ready: function () {
        this.$.main.addEventListener('logout', function (event) {
          this.emitEvent('user:logout', true);
        }.bind(this));
        this.$.main.addEventListener('login', function (event) {
          this.emitEvent('user:login', {
            url: window.location.href,
            scopes: []
          });
        }.bind(this));
        this.$.main.addEventListener('relogin', function (event) {
          this.emitEvent('user:login', {
            url: window.location.href,
            scopes: [event.detail]
          });
        }.bind(this));
        this.$.main.addEventListener('fetchRemote', function (event) {
          this.emitEvent('flowhub:projects:fetch', event.detail);
        }.bind(this));
        this.$.main.addEventListener('fetchRuntimes', function (event) {
          this.emitEvent('flowhub:runtimes:fetch', event.detail);
        }.bind(this));
        this.$.main.addEventListener('newgraph', function (event) {
          this.emitEvent('storage:save:graph', event.detail);
        }.bind(this));
        this.$.main.addEventListener('newruntime', function (event) {
          this.emitEvent('flowhub:runtimes:register', event.detail);
        }.bind(this));
        this.$.main.addEventListener('newproject', function (event) {
          this.emitEvent('storage:save:project', event.detail);
        }.bind(this));
        this.$.main.addEventListener('hash', function (event) {
          this.emitEvent('application:hash', event.detail);
        }.bind(this));
        this.$.context.addEventListener('newgraph', function (event) {
          this.emitEvent('storage:save:graph', event.detail);
          this.emitEvent('runtime:sendGraph', event.detail);
        }.bind(this));
        this.$.runtime.addEventListener('runtime', function (event) {
          var newCtx = {};
          for (var key in this.ctx) {
            newCtx[key] = this.ctx[key];
          }
          newCtx.runtime = event.detail;
          this.emitEvent('runtime:connect', newCtx);
        }.bind(this));
        this.$.runtime.addEventListener('changed', function (event) {
          this.emitEvent('storage:save:runtime', event.detail);
        }.bind(this));
        this.$.grapheditor.addEventListener('edges', function (event) {
          this.emitEvent('context:edges', event.detail);
        }.bind(this));
        this.$.grapheditor.addEventListener('nodes', function (event) {
          this.emitEvent('context:nodes', event.detail);
        }.bind(this));
        this.$.project.addEventListener('changed', function (event) {
          this.emitEvent('storage:save:project', event.detail);
        }.bind(this));
        this.$.project.addEventListener('newgraph', function (event) {
          this.emitEvent('storage:save:graph', event.detail);
          this.emitEvent('runtime:sendGraph', event.detail);
          this.triggerTests();
        }.bind(this));
        this.$.project.addEventListener('newcomponent', function (event) {
          this.emitEvent('storage:save:component', event.detail);
          this.emitEvent('runtime:sendComponent', event.detail);
        }.bind(this));
        this.$.project.addEventListener('sync', function (event) {
          this.emitEvent('github:sync:prepare', event.detail);
        }.bind(this));
        this.$.project.addEventListener('syncDecision', function (event) {
          this.emitEvent('github:sync:synchronize', event.detail);
        }.bind(this));
        this.$.project.addEventListener('deleteProject', function (event) {
          this.emitEvent('application:hash', []);
          event.detail.graphs.forEach(function (graph) {
            this.emitEvent('storage:delete:graph', graph);
          }.bind(this));
          event.detail.components.forEach(function (component) {
            this.emitEvent('storage:delete:component', component);
          }.bind(this));
          event.detail.specs.forEach(function (spec) {
            this.emitEvent('storage:delete:spec', spec);
          }.bind(this));
          this.emitEvent('storage:delete:project', event.detail);
          this.$.main.projects.splice(this.$.main.projects.indexOf(event.detail), 1);
          this.$.main.localProjects.splice(this.$.main.localProjects.indexOf(event.detail), 1);
        }.bind(this));
        this.$.project.addEventListener('hash', function (event) {
          this.emitEvent('application:hash', event.detail);
        }.bind(this));
        this.$.main.addEventListener('deleteProject', function (event) {
          this.emitEvent('application:hash', []);
          event.detail.graphs.forEach(function (graph) {
            this.emitEvent('storage:delete:graph', graph);
          }.bind(this));
          event.detail.components.forEach(function (component) {
            this.emitEvent('storage:delete:component', component);
          }.bind(this));
          event.detail.specs.forEach(function (spec) {
            this.emitEvent('storage:delete:spec', spec);
          }.bind(this));
          this.emitEvent('storage:delete:project', event.detail);
          this.$.main.projects.splice(this.$.main.projects.indexOf(event.detail), 1);
          this.$.main.localProjects.splice(this.$.main.localProjects.indexOf(event.detail), 1);
        }.bind(this));
        this.$.componenteditor.addEventListener('changed', function (event) {
          this.emitEvent('storage:save:component', event.detail);
          this.emitEvent('runtime:sendComponent', event.detail);
          this.triggerTests();
        }.bind(this));
        this.$.componenteditor.addEventListener('specschanged', function (event) {
          this.emitEvent('storage:save:spec', event.detail);
          this.triggerTests();
        }.bind(this));
        this.$.search.addEventListener('search:library', function (event) {
          this.emitEvent('workspace:search:library', event.detail);
        }.bind(this));
        this.$.search.addEventListener('search:graph', function (event) {
          this.emitEvent('workspace:search:graph', event.detail);
        }.bind(this));
        this.$.library.addEventListener('results', function (event) {
          this.emitEvent('workspace:search:results:library', event.detail);
        }.bind(this));
        this.$.search.addEventListener('deleteGraph', function (event) {
          var project = this.ctx.project || this.$.project.project;
          if (project && project.graphs.indexOf(event.detail) !== -1) {
            project.graphs.splice(project.graphs.indexOf(event.detail), 1);
          }
          this.emitEvent('storage:delete:graph', event.detail);
          if (!project.graphs.length && !project.components.length) {
            // Empty project, remove
            this.emitEvent('storage:delete:project', project);
            this.$.main.projects.splice(this.$.main.projects.indexOf(project), 1);
            this.$.main.localProjects.splice(this.$.main.localProjects.indexOf(project), 1);
            // Go home
            this.emitEvent('application:hash', []);
          } else if (project.graphs[0]) {
            // Go to first graph
            this.emitEvent('application:hash', [
              'project',
              project.id,
              project.graphs[0].properties.id
            ]);
          } else if (project.components[0]) {
            // Go to first component
            this.emitEvent('application:hash', [
              'project',
              project.id,
              'component',
              project.components[0].name
            ]);
          }
        }.bind(this));
        this.$.search.addEventListener('deleteComponent', function (event) {
          var project = this.ctx.project || this.$.project.project;
          if (!project || !project.components) {
            return;
          }
          var component = event.detail;
          var index = project.components.indexOf(component);
          if (index !== -1) {
            project.components.splice(index, 1);
          }
          this.emitEvent('storage:delete:component', component);
          if (!project.graphs.length && !project.components.length) {
            // Empty project, remove
            this.emitEvent('storage:delete:project', project);
            this.$.main.projects.splice(this.$.main.projects.indexOf(project), 1);
            this.$.main.localProjects.splice(this.$.main.localProjects.indexOf(project), 1);
            // Go home
            this.emitEvent('application:hash', []);
          } else if (project.components[0]) {
            // Go to first component
            this.emitEvent('application:hash', [
              'project',
              project.id,
              'component',
              project.components[0].name
            ]);
          } else if (project.graphs[0]) {
            // Go to first graph
            this.emitEvent('application:hash', [
              'project',
              project.id,
              project.graphs[0].properties.id
            ]);
          }
        }.bind(this));
        this.$.search.addEventListener('specschanged', function (event) {
          this.emitEvent('storage:save:spec', event.detail);
          this.triggerTests();
        }.bind(this));
        this.$.library.editor = this.$.grapheditor;
        this.$.journal.editor = this.$.grapheditor;
        this.$.context.editor = this.$.grapheditor;
        this.$.packets.editor = this.$.grapheditor;
        this.$.search.editor = this.$.grapheditor;
        this.$.runtime.panel = this.$.context.$.fixed;
        this.$.packets.panel = this.$.context.$.context;
        this.$.search.panel = this.$.context.$.context;
      },
      state: function (state) {
        // Show loading/error indicators as needed
        this.handleStatus(state);
        // Update local state reference
        this.ctx = state;
        // Pass data to views
        // Logged in user
        this.user(state.user);
        // Project currently open
        this.$.main.project = state.workspace.project;
        this.$.project.project = state.workspace.project;
        this.$.context.project = state.workspace.project;
        this.$.componenteditor.project = state.workspace.project;
        this.$.search.project = state.workspace.project;
        // Current graph being edited
        this.$.project.graph = state.workspace.graph;
        this.$.journal.graph = state.workspace.graph;
        this.$.runtime.graph = state.workspace.graph;
        this.$.context.graph = state.workspace.graph;
        this.$.search.graph = state.workspace.graph;
        this.$.grapheditor.graph = state.workspace.graph;
        this.$.packets.currentgraph = state.workspace.graph;
        // Current component being edited
        this.$.project.component = state.workspace.component;
        this.$.componenteditor.component = state.workspace.component;
        this.$.search.component = state.workspace.component;
        this.$.library.graphs = state.workspace.graphs;
        // Graph viewing path
        this.$.project.graphs = state.workspace.graphs;
        this.$.context.graphs = state.workspace.graphs;
        this.$.search.graphs = state.workspace.graphs;
        // Current runtime connection
        this.$.runtime.runtime = state.workspace.runtime.selected;
        this.$.context.runtime = state.workspace.runtime.selected;
        this.$.componenteditor.runtime = state.workspace.runtime.selected;
        // List of runtimes available
        this.$.main.runtimes = state.runtimes.local;
        this.$.main.currentRuntimes = state.runtimes.current;
        this.$.project.runtimes = state.runtimes.local;
        this.$.search.runtimes = state.runtimes.local;
        // Filtered list of compatible runtimes
        this.$.runtime.runtimes = state.workspace.runtime.compatible;
        // Projects listings
        this.$.main.projects = state.projects.local;
        this.$.main.remoteProjects = state.projects.remote;
        this.$.context.nodes = state.workspace.selection.nodes;
        // Examples listings
        this.$.main.examples = state.examples.remote;
        // IndexedDB connection
        this.$.journal.db = state.db;
        // Selection state
        this.$.packets.edges = state.workspace.selection.edges;
        this.$.packets.nodes = state.workspace.selection.nodes;
        // Search
        this.$.library.search = state.workspace.search.query;
        this.$.search.libraryresults = state.workspace.search.components;
        this.$.search.graphResults = state.workspace.search.nodes;
        this.$.library.components = state.workspace.library;
        // TODO: error, packet, sync, suites
      },
      handleStatus: function (state) {
        if (!state.state) {
          return;
        }
        switch (state.state) {
          case 'error':
            this.showError(state);
            break;
          case 'ok':
            this.hideAlertSoon();
            break;
          case 'loading':
            this.showProgress(state);
            break;
        }
      },
      user: function (user) {
        this.$.main.githubToken = user['github-token'];
        this.$.main.gridToken = user['grid-token'];
        this.$.main.user = user['grid-user'];
        if (user['grid-avatar']) {
          this.$.main.avatar = user['grid-avatar'];
        }
        this.$.main.plan = user['flowhub-plan'];
        this.$.project.gridToken = user['grid-token'];
      },
      showError: function (context) {
        if (context.error && context.error.message) {
          this.$.alert.message = context.error.message;
          this.$.alert.isError = true;
          this.$.alert.offerHTTPS = false;
          this.$.alert.classList.add('show');
        }
      },
      showProgress: function (context) {
        if (context.state || context.offerHTTPS) {
          this.$.alert.message = context.state || "";
          this.$.alert.isError = false;
          this.$.alert.offerHTTPS = context.offerHTTPS || false;
          this.dontAutoHideAlert = context.dontAutoHideAlert || false;
          this.$.alert.classList.add('show');
        }
      },
      triggerTests: function () {
        this.emitEvent('runtime:runTests', this.ctx.project || this.$.project.project);
      },
      hideAlert: function () {
        this.$.alert.classList.remove('show');
      },
      hideAlertSoon: function () {
        if (this.dontAutoHideAlert) { return; }
        window.setTimeout(function(){
          this.hideAlert();
        }.bind(this), 1300);
      }
    });
  </script>
</polymer-element>
